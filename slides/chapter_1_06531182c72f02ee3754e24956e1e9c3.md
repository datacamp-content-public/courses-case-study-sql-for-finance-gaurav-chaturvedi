---
title: 'Insert title here'
key: 06531182c72f02ee3754e24956e1e9c3
---

## Free Margin

```yaml
type: TitleSlide
key: e3d826c285
```

`@lower_third`
name: Gaurav Chaturvedi
title: Instructor

`@script`
In the previous lesson you applied the concept of required margin and unrealized gain / loss using 2 datasets - FX Rates and FX Positions. 

In this lesson, you will learn about Free Margin. You will use SQL Joins, Aggregations and Calculated Fields to compute Free Margin. 

So let's get started!

---

## Let's Recap (1/3)

```yaml
type: FullSlide
key: 7a659077fe
```

`@part1`
&nbsp;

## 1. Customer A starts with USD 10k in the account
&nbsp;

   
![](https://assets.datacamp.com/production/repositories/5112/datasets/d59bef374c0f01a913e61d0f11b10c5794063ba6/Img1.png =50)

`@script`
Free margin is derived from required margin and unrealized gain / loss, so lets do a quick recap of these 2 concepts.

Let's say on the 1st of January, Customer A starts with Ten Thousand US Dollars in his account.

---

## Let's Recap (2/3)

```yaml
type: FullSlide
key: 17af617ee7
```

`@part1`
&nbsp;

## 2. Customer A buys 1 lot of EUR-USD @ 1.092.   
@4% margin he needs margin of EUR 4k (or USD 4,368 @1.092)
&nbsp;

![](https://assets.datacamp.com/production/repositories/5112/datasets/2462a083ca467ddd22bb376538ce2a1ff1e392dd/Img2.png =50)

`@script`
On 1st Jan itself, he buys 1 lot of EUR-USD at the exchange rate of 1.092. Recall that this means he buys 100,000 EUR against USD at 1 EUR = 1.092 USD. 

He needs to keep aside a margin for this position. 
4% margin for EUR-USD currency pair, means Four Thousand Euros for this position of 100,000 Euros. 

Since the account is in USD, we convert the required margin of Four Thousand Euros into USD - @1.092 it works out to USD 4,368.

---

## Let's Recap (3/3)

```yaml
type: FullSlide
key: 5996f992b5
```

`@part1`
&nbsp;

## 3. EUR-USD exchange rate moves to 1.122
Customer A has a profit of **USD 3,000**
&nbsp;

![](https://assets.datacamp.com/production/repositories/5112/datasets/c62e10eeebf665fa0aca42b94d873b418c4b8797/Img3.png =50)

`@script`
The exchange rate moves in his favour to 1.122. Since he bought EUR at 1 EUR = 1.092 USD, he gains USD 0.03 (1.122 - 1.092) for every EUR he holds. 
He holds 1 lot which is 100,000 EUR. That means his total  unrealised gain in USD is 0.03 * 100,000 which is USD 3,000.

---

## So what is Free Margin?

```yaml
type: FullSlide
key: 14c26a1b41
```

`@part1`
&nbsp;
![](https://assets.datacamp.com/production/repositories/5112/datasets/08f616734331f92c998d6b46b6ae29779636d517/Img4.png =50)

## Free Margin
**Cash Balance - Required Margin + Unrealised Gain **

`@script`
This means he now has USD 8,632 is his account that he can use as he pleases - he can use that to take new positions or simply withdraw it from the account. 

This is Free Margin. 

Free Margin is the NET amount of $  available to the customer at any point in time. Mathematically it is equal to:
 Cash Balance + Unrealised Gain - Used Margin

Please note that Unrealised loss should be subtracted (while gain is added)

---

## ER Diagram

```yaml
type: FullSlide
key: 1276ee3e12
```

`@part1`
&nbsp;

![](https://assets.datacamp.com/production/repositories/5112/datasets/4683d7ca2e53682f7ecd5468033388cda3a9ded1/Img5v3.png =90)

`@script`
We have seen 3 datasets till the last chapter. 
1."fx_rates" has the currency rates by date. 
2."fx_positions_plus" dataset has all customer open positions and the 2 computed fields - required margin and unrealised gain
3."margin_master" has currency pair wise margin requirement in percentage. 
 
In this lesson we will introduce a new Customer level dataset called customer_balance. The customer opening cash balance will be provided in this table.

---

## Outcome Dataset

```yaml
type: FullSlide
key: bb76bdb380
```

`@part1`
&nbsp;
![](https://assets.datacamp.com/production/repositories/5112/datasets/300cb1e4a51183249dab838ef373862f10e4835c/Img6v3.png =40)

`@script`
You will create a new dataset that has cash balance required margin, unrealised gain and free margin at the customer level. 

We will do this in 3 steps.

---

## Calculating Free Margin - Step 1

```yaml
type: FullSlide
key: e140bab8b5
```

`@part1`
&nbsp;
## Aggregate required margin and unrealized gain at customer level. Create a new table 
&nbsp;

```
SELECT 
SUM() -- fields to aggregate
INTO customer_margin_gain
FROM fx_position_plus 
GROUP BY () -- customer level 
```

`@script`
Step 1: Aggregate the required margin and unrealised gain from the fx_position_plus table to create a new table customer_margin_gain.
We will use SUM and Group By to aggregate and INTO to create a new table.

---

## Calculating Free Margin - Step 2

```yaml
type: FullSlide
key: 93dd34aa84
```

`@part1`
&nbsp;
## Join this new table with the customer balance table
&nbsp;

```
SELECT 
INTO customer_margin_gain_balance
FROM 
fx_position_plus a, 
INNER JOIN customer_balance b
ON (a. = b.) -- use the joining key
```

`@script`
Step 2: Now you need to Join this newly created table with customer_balance table to bring the cash balance together with the required margin and unrealized gain. Lets call this new table customer_margin_gain_balance. 

Use INNER JOIN to do this.

---

## Calculating Free Margin - Step 3

```yaml
type: FullSlide
key: e850309f8c
```

`@part1`
&nbsp;
## Compute the Free Margin 

**Free Margin** = Cash Balance + Unrealised Gain - Used Margin
&nbsp;

```
SELECT 
() as cust_free_margin
-- other fields as per the outcome dataset
INTO customer_free_margin
FROM 
customer_margin_gain_balance
```

`@script`
Now you have the 3 data points to calculate Free Margin for a Customer. Use the formula of Free Margin to add a new field in the customer_margin_gain_balance table. We call the new table customer_free_margin

You will use calculated files with alias to compute Free Margin.

---

## Let's practice!

```yaml
type: FinalSlide
key: 6b2a879e96
```

`@script`
