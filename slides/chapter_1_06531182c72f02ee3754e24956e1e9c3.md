---
title: 'Insert title here'
key: 06531182c72f02ee3754e24956e1e9c3
---

## Free Margin

```yaml
type: TitleSlide
key: e3d826c285
```

`@lower_third`
name: Gaurav Chaturvedi
title: Instructor

`@script`
In the previous lesson you applied the concept of required margin and unrealized gain / loss using 2 datasets - FX Rates and FX Positions. 

In this lesson, you will learn about Free Margin. You will use SQL Joins, Aggregations and calculated fields to compute Free Margin. 

So let's get started! 

---

## Let's recap required margin and unrealized gain / loss (1/3)

```yaml
type: TwoColumns
key: b3b9bbec89
disable_transition: true
code_zoom: 100
```

`@part1`
## 1. Customer A starts with USD 10k in the account

`@part2`
![](https://assets.datacamp.com/production/repositories/5112/datasets/184dfa456afcb266eb73c5e70853dda82e5becc8/Img1.1.png = 120)

`@script`
Since Free margin is derived from required margin and unrealized gain / loss, lets do a quick recap.

On the 1st of January, Customer A starts with Ten Thousand US Dollars in his account. 

`@citations`
1.

---

## Let's recap required margin and unrealized gain / loss (2/3)

```yaml
type: TwoColumns
key: c1daa19a87
```

`@part1`
**2. Customer A buys 1 lot of EUR-USD @ 1.092.  **   
@4% margin he needs to keep aside EUR 4k (or USD 4,368 @1.092) margin

`@part2`
![](https://assets.datacamp.com/production/repositories/5112/datasets/5b90e5ae6c2f7b37c575044e18bbe4556d06d664/Img1.2.png)

`@script`
On 1st Jan itself, he buys 1 lot of EUR-USD at the exchange rate of 1.092. Recall that this means he buys 100,000 EUR against USD at 1 EUR = 1.092 USD. 

@4% margin for EUR-USD currency pair, he needs to set aside a margin of Four Thousand Euro from his account. Since the account is in USD, we convert the required margin of Euro 4k into USD - @1.092 it is USD 4,368. 

---

## Let's recap required margin and unrealized gain / loss (3/3)

```yaml
type: FullSlide
key: 6f3384f074
```

`@part1`
### 2. Customer A buys 1 lot of EUR-USD @ 1.092.   
@4% margin he needs to keep aside EUR 4k (or USD 4,368 @1.092) margin   
![](https://assets.datacamp.com/production/repositories/5112/datasets/5b90e5ae6c2f7b37c575044e18bbe4556d06d664/Img1.2.png =50)

`@script`
The exchange rate moves in his favour to 1.122. This means he gains USD 0.03 on each Euro he holds. On his 1 lot position his unrealised gain is USD 3,000.  

---

## So what is Free Margin?

```yaml
type: TwoRows
key: 1618c2edd7
```

`@part1`
### 2. Customer A buys 1 lot of EUR-USD @ 1.092.   
@4% margin he needs to keep aside EUR 4k (or USD 4,368 @1.092) margin

`@part2`
![](https://assets.datacamp.com/production/repositories/5112/datasets/5b90e5ae6c2f7b37c575044e18bbe4556d06d664/Img1.2.png =40)

`@script`
This means he now has USD 8,632 is his account that he can use as he pleases - he can use that to take new positions or simply withdraw it from the account. 

This is Free Margin. 

Free Margin is the NET amount of $  available to the customer at any point in time. Mathematically it is equal to:
 Cash Balance + Unrealised Gain - Used Margin

Please note that Unrealised loss should be subtracted (while gain is added)

---

## ER Diagram 

```yaml
type: FullSlide
key: 1276ee3e12
```

`@part1`
**Free Margin** = Cash Balance + MTM - Used Margin

`@script`
We have seen 3 datasets till the last chapter. 
1."fx_rates" has the currency rates by date. 
2."fx_positions_plus" dataset has all customer open positions and the 2 computed fields - required margin and unrealised gain
3."margin_master" has currency pair wise margin requirement in percentage. 
 
In this lesson we will use a new Customer level dataset called customer_balance. The customer opening cash balance will be provided. You will need to compute the total required margin and unrealised gain at customer level. We will use these fields to compute customer free margin.

---

## Calculating Free Margin - Step 1

```yaml
type: TwoColumns
key: f12bc13a80
```

`@part1`


`@part2`


`@script`
We will calculate Free Margin in 3 steps: 

Step 1: Aggregate the required margin and unrealised gain at the customer level to create a new table customer_margin_gain.
Recall from your SQL lessons the usage of Group BY to aggregate and INTO to create a new table. 

---

## Calculating Free Margin - Step 2

```yaml
type: FullSlide
key: 93dd34aa84
```

`@part1`


`@script`


---

## Let's practice!

```yaml
type: FinalSlide
key: 6b2a879e96
```

`@script`
