---
title: 'Insert title here'
key: 06531182c72f02ee3754e24956e1e9c3
---

## Free Margin

```yaml
type: TitleSlide
key: e3d826c285
```

`@lower_third`
name: Gaurav Chaturvedi
title: Instructor

`@script`
In the previous lesson you applied the concept of required margin and unrealized gain / loss using 2 datasets - FX Rates and FX Positions. 

In this lesson, you will learn about Free Margin. You will use SQL Joins, Aggregations and Calculated Fields to compute Free Margin. 

So let's get started! 

---

## Let's Recap (1/3)

```yaml
type: TwoColumns
key: b3b9bbec89
disable_transition: true
code_zoom: 100
```

`@part1`
## 1. Customer A starts with USD 10k in the account

`@part2`
![](https://assets.datacamp.com/production/repositories/5112/datasets/d59bef374c0f01a913e61d0f11b10c5794063ba6/Img1.png)

`@script`
Free margin is derived from required margin and unrealized gain / loss, so lets do a quick recap of these 2 concepts.

Let's say on the 1st of January, Customer A starts with Ten Thousand US Dollars in his account. 

`@citations`
1.

---

## Insert title here...

```yaml
type: FullSlide
key: 7a659077fe
```

`@part1`
&nbsp;

## 1. Customer A starts with USD 10k in the account
&nbsp;

   
![](https://assets.datacamp.com/production/repositories/5112/datasets/d59bef374c0f01a913e61d0f11b10c5794063ba6/Img1.png =50)

`@script`


---

## Let's recap required margin and unrealized gain / loss (2/3)

```yaml
type: TwoColumns
key: c1daa19a87
```

`@part1`
**2. Customer A buys 1 lot of EUR-USD @ 1.092.  **   
@4% margin he needs to keep aside EUR 4k (or USD 4,368 @1.092) margin

`@part2`
![](https://assets.datacamp.com/production/repositories/5112/datasets/5b90e5ae6c2f7b37c575044e18bbe4556d06d664/Img1.2.png)

`@script`
On 1st Jan itself, he buys 1 lot of EUR-USD at the exchange rate of 1.092. Recall that this means he buys 100,000 EUR against USD at 1 EUR = 1.092 USD. 

@4% margin for EUR-USD currency pair, he needs to set aside a margin of Four Thousand Euro from his account. Since the account is in USD, we convert the required margin of Euro 4k into USD - @1.092 it works out to USD 4,368. 

---

## Let's recap required margin and unrealized gain / loss (3/3)

```yaml
type: FullSlide
key: 6f3384f074
```

`@part1`
### 2. Customer A buys 1 lot of EUR-USD @ 1.092.   
@4% margin he needs to keep aside EUR 4k (or USD 4,368 @1.092) margin   
![](https://assets.datacamp.com/production/repositories/5112/datasets/5b90e5ae6c2f7b37c575044e18bbe4556d06d664/Img1.2.png =50)

`@script`
The exchange rate moves in his favour to 1.122. Since he bought EUR at 1 EUR = 1.092 USD, he gains USD 0.03 (1.122 - 1.092) for every EUR he holds. 
He holds 1 lot which is 100,000 EUR. That means his total  unrealised gain in USD is 0.03 * 100,000 which is USD 3,000.  

---

## So what is Free Margin?

```yaml
type: TwoRows
key: 1618c2edd7
```

`@part1`


`@part2`


`@script`
This means he now has USD 8,632 is his account that he can use as he pleases - he can use that to take new positions or simply withdraw it from the account. 

This is Free Margin. 

Free Margin is the NET amount of $  available to the customer at any point in time. Mathematically it is equal to:
 Cash Balance + Unrealised Gain - Used Margin

Please note that Unrealised loss should be subtracted (while gain is added)

---

## ER Diagram 

```yaml
type: FullSlide
key: 1276ee3e12
```

`@part1`
**Free Margin** = Cash Balance + MTM - Used Margin

`@script`
We have seen 3 datasets till the last chapter. 
1."fx_rates" has the currency rates by date. 
2."fx_positions_plus" dataset has all customer open positions and the 2 computed fields - required margin and unrealised gain
3."margin_master" has currency pair wise margin requirement in percentage. 
 
In this lesson we will introduce a new Customer level dataset called customer_balance. The customer opening cash balance will be provided in this table.

---

## Outcome Dataset 

```yaml
type: FullSlide
key: bb76bdb380
```

`@part1`


`@script`
You will create a new dataset that has cash balance required margin, unrealised gain and free margin at the customer level. 

We will do this in 3 steps. 


---

## Calculating Free Margin - Step 1

```yaml
type: TwoColumns
key: f12bc13a80
```

`@part1`


`@part2`


`@script`
Step 1: Aggregate the required margin and unrealised gain at the customer level to create a new table customer_margin_gain.
We will use Group By to aggregate and INTO to create a new table. 

---

## Calculating Free Margin - Step 2

```yaml
type: FullSlide
key: 93dd34aa84
```

`@part1`


`@script`
Step 2: Now you need to Merge this newly created table with customer_balance table to bring the balance column together with the required margin and free margin. Lets call this new table customer_margin_gain_balance. 

Use INNER JOIN ON the joining key, customer_id to merge. 

---

## Calculating Free Margin - Step 3

```yaml
type: FullSlide
key: e850309f8c
```

`@part1`


`@script`
Now you have the 3 data points to calculate Free Margin for a Customer. Use the formula of Free Margin to add a new field in the customer_margin_gain_balance table. 

You can use calculated files with alias to compute Free Margin. 

---

## Let's practice!

```yaml
type: FinalSlide
key: 6b2a879e96
```

`@script`
